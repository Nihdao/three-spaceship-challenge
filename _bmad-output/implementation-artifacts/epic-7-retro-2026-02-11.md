# Epic 7 Retrospective â€” Tunnel Hub & Multi-System Progression

**Date:** 2026-02-11
**Epic:** Epic 7 â€” Tunnel Hub & Multi-System Progression (Tier 2/3)
**Status:** Done (4/4 stories completed)
**Participants:** Scrum Master (Bob), Product Owner (Alice), Senior Dev (Charlie), QA Engineer (Dana), Junior Dev (Elena), Project Lead (Adam)

---

## Epic Overview

Epic 7 delivered a complete tunnel hub system that fundamentally transforms the game's progression model. Players now experience:

- **Fragment Currency System:** Permanent economy spanning multiple systems
- **Permanent Upgrades:** 9 distinct upgrades providing lasting power increases
- **Meaningful Dilemmas:** 6 risk/reward choices with tradeoffs
- **System Transitions:** Difficulty scaling across systems (1.0x â†’ 1.3x â†’ 1.6x)
- **HP Sacrifice:** Strategic option to convert 50 fragments into 25 HP recovery
- **3D Tunnel Scene:** Immersive environment for hub interactions

### Stories Completed

1. **7-1: Tunnel Entry & 3D Scene** (20 tests)
2. **7-2: Fragment Upgrades & Dilemmas** (26 tests)
3. **7-3: Tunnel Exit & System Transition** (27 tests)
4. **7-4: HP Sacrifice** (14 tests)

**Test Coverage:** 470 â†’ 537 tests (+67 new, 0 regressions)
**Code Review Impact:** 9 HIGH + 7 MEDIUM issues caught before runtime

---

## What Went Well âœ…

### 1. Fragment Economy Foundation
The fragment currency system provides a stable foundation for permanent progression. The 50-fragment upgrade cost and 10/20/30 fragment dilemma rewards create a clear progression curve across multiple systems.

### 2. Upgrade & Dilemma Diversity
9 upgrades and 6 dilemmas offer meaningful strategic choices. Each upgrade provides concrete power increases (e.g., +20% damage, +2 max HP), and dilemmas present genuine risk/reward tradeoffs (e.g., +100 fragments but harder enemies).

### 3. Difficulty Scaling Implementation
The `SYSTEM_DIFFICULTY_MULTIPLIERS` (1.0x/1.3x/1.6x) and `totalElapsedTime` tracking provide a clean foundation for escalating challenge as players progress through systems.

### 4. Architecture Discipline
All stories maintained the 6-layer architecture pattern. The `GameLoop` orchestration pattern (stores never import stores) was consistently applied, preventing circular dependencies and keeping state management clean.

### 5. Test Coverage Growth
67 new tests with zero regressions demonstrates strong testing discipline. Tests covered edge cases like:
- Insufficient fragment scenarios
- HP sacrifice at max HP
- Difficulty multiplier stacking
- System transition state integrity

### 6. Code Review Safety Net
The code review workflow caught 16 issues (9 HIGH, 7 MEDIUM) before runtime, including:
- Pre-existing debug values (BOSS_HP=1)
- Incorrect import paths
- Missing localStorage mocks in tests
- GameLoop reset guard complexity

---

## Challenges & Lessons Learned ðŸ§­

### 1. Stores Importing Stores Anti-Pattern (Recurring)
**Occurred in:** Stories 7.1, 7.3
**Pattern:** Initial implementations had `useLevel` importing `usePlayer` or vice versa, violating the "stores never import stores" principle.
**Resolution:** Moved all cross-store coordination to `GameLoop.jsx` orchestration.
**Lesson:** This pattern emerged in multiple stories. Consider architecture linting or pre-story checklist to catch early.

### 2. Reset State Management Complexity
**Occurred in:** Stories 7.1, 7.3, 7.4
**Pattern:** Two reset patterns exist:
- `reset()` â€” Full game restart (clears fragments, upgrades, system progress)
- `resetForNewSystem()` â€” Cross-system state preservation (keeps fragments, upgrades, system count)

**Challenge:** Determining which state fields belong in which reset function required careful analysis each time.
**Resolution:** Each story clearly documented reset behavior and added tests for both patterns.
**Lesson:** A centralized state lifecycle document would help developers understand which fields are "persistent" vs "per-system" vs "per-run".

### 3. Debug Values Left in Production Code
**Occurred in:** Story 7.3
**Issue:** Pre-existing `BOSS_HP=1` debug value was discovered during story implementation.
**Resolution:** Fixed to `BOSS_HP=500` during the story.
**Lesson:** Code review workflow is catching these, but a pre-commit hook or debug-value linter could catch them earlier.

### 4. localStorage Mock Pattern in Tests
**Occurred in:** Story 7.1
**Issue:** Tests failed when `useLevel` tried to access `localStorage` in Node environment.
**Resolution:** Added `globalThis.localStorage` mock with `getItem`, `setItem`, `removeItem`, and `mockClear()` in tests.
**Lesson:** This is a known pattern now. Consider adding localStorage mock to global test setup to avoid repeating in each test file.

---

## Key Metrics & Technical Observations ðŸ“Š

### Test Coverage Evolution
- **Epic 7 Start:** 470 tests
- **Epic 7 End:** 537 tests (+67 new, +14.3% growth)
- **Zero Regressions:** All existing tests passed throughout epic

### Code Review Impact
- **Total Issues:** 16 (9 HIGH, 7 MEDIUM)
- **Examples:**
  - Debug value correction (BOSS_HP)
  - Import path fixes (useBoss)
  - Mock implementations (localStorage)
  - State isolation (GameLoop reset guards)

### Architecture Adherence
- **6-Layer Pattern:** Maintained across all stories
- **GameLoop Orchestration:** All cross-store coordination moved to GameLoop
- **Store Independence:** No store-to-store imports in final implementation

---

## Action Items from Previous Retrospective (Epic 6)

### 1. Automated reset() Coverage Tests
**Status:** Partially deferred (3rd epic in a row)
**Context:** Epic 6 identified need for automated tests verifying all stores implement `reset()` correctly. Epic 7 also encountered reset-related complexity (two reset patterns: `reset()` vs `resetForNewSystem()`).
**Decision:** Continue deferring until polish pass after sprint planning. Priority remains MEDIUM.

### 2. Boss Arena Design Patterns
**Status:** Acknowledged, no action taken
**Context:** Epic 6 identified potential for reusable boss arena patterns if more bosses are added.
**Decision:** No additional bosses planned in Epic 7, so this remains on backlog for future consideration.

---

## Action Items for Next Epic ðŸŽ¯

### Action Item 1: Add Player Stats Visibility in Tunnel UI
**Owner:** Dev Agent (future sprint)
**Priority:** HIGH
**Context:** User feedback during Epic 7 retrospective: "j'aimerais que toutes les stats joueurs soient visible au joueur pour voir vraiment concrÃ¨tement les choses"
**Success Criteria:**
- TunnelHub displays concrete player stats:
  - Base damage
  - All active multipliers (upgrades, dilemmas, difficulty)
  - Final calculated values (e.g., "12 base Ã— 1.2 upgrade Ã— 1.4 dilemma = 20.16 damage")
- Stats update in real-time as player makes upgrade/dilemma choices
- Clear visual presentation that helps players understand upgrade impacts

**Rationale:** Players can't currently see concrete impacts of upgrades/dilemmas on their stats. Adding visibility makes strategic choices more meaningful and rewarding.

---

### Action Item 2: Automated reset() Coverage Tests
**Owner:** Dev Agent
**Priority:** MEDIUM (3rd epic deferral)
**Deadline:** During polish pass after sprint planning
**Success Criteria:**
- Automated test verifies all Zustand stores implement `reset()` method
- Test checks that `reset()` restores all state fields to initial values
- Catches missing fields in reset() implementations (e.g., if a new field is added but not included in reset)

**Rationale:** This issue has been deferred across Epic 5, Epic 6, and now Epic 7. The `resetForNewSystem()` vs `reset()` pattern in Epic 7 highlights the growing complexity of state lifecycle management. Time to address this technical debt.

---

### Action Item 3: Architecture Linting for Store Cross-Imports
**Owner:** Dev Agent (optional)
**Priority:** LOW
**Success Criteria:**
- ESLint rule or custom script detects when one Zustand store imports another
- Rule suggests moving coordination logic to GameLoop
- Optional: Run as pre-commit hook or CI check

**Rationale:** The "stores importing stores" anti-pattern appeared in Stories 7.1 and 7.3. While code review caught both cases, automated detection would catch this earlier in the development cycle.

---

### Action Item 4: Document GameLoop Orchestration Pattern
**Owner:** Tech Lead
**Priority:** LOW
**Deliverable:** Architecture documentation section explaining:
- Why stores shouldn't import stores (circular dependency risk, coupling)
- How GameLoop acts as orchestrator (tick() order, cross-store coordination)
- When to add logic to GameLoop vs store (guideline: if it reads from 2+ stores, it belongs in GameLoop)
- Example: Player death detection (reads usePlayer + useGame, lives in GameLoop)

**Rationale:** This pattern has been successfully applied throughout the project, but it's not formally documented. Future developers or AI agents would benefit from explicit guidance.

---

## Team Celebration ðŸŽ‰

**Epic 7 Achievement:** Complete tunnel hub system with permanent progression framework

**Project Milestone:** 7 epics completed
- âœ… Epic 1: Ship Flight & Space Environment
- âœ… Epic 2: Combat & Enemy Waves
- âœ… Epic 3: Progression & Build Crafting
- âœ… Epic 4: Complete Game Loop & Polish
- âœ… Epic 5: Dash & Planet Exploration
- âœ… Epic 6: Boss Encounters & System Completion
- âœ… Epic 7: Tunnel Hub & Multi-System Progression

**Team Commitment:** All action items approved and committed by the team.

**Next Steps:** Sprint planning to define next epics and continue the journey! ðŸš€

---

## Retrospective Metadata

**Workflow:** BMad retrospective workflow (`_bmad/bmm/workflows/4-implementation/retrospective/`)
**Generated:** 2026-02-11
**Epic Stories:**
- `7-1-tunnel-entry-3d-scene.md`
- `7-2-fragment-upgrades-dilemmas.md`
- `7-3-tunnel-exit-system-transition.md`
- `7-4-hp-sacrifice.md`

**Previous Retrospective:** `epic-6-retro-2026-02-11.md`
**Sprint Status:** Updated from `epic-7: in-progress` â†’ `epic-7: done`
