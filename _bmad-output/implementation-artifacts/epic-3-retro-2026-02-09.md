# Retrospective — Epic 3: Progression & Build Crafting

**Date:** 2026-02-09
**Facilitator:** Bob (Scrum Master)
**Epic Status:** Complete (5/5 stories done)
**Participants:** Adam (Project Lead), Alice (Product Owner), Bob (Scrum Master), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev)

## Epic 3 Summary

### Delivery Metrics

- Stories Completed: 5/5 (100%)
- Stories Originally Planned: 5 — No mid-epic scope additions
- Code Reviews Completed: 5/5
- Test Coverage: 156 → 243 tests (+87 new, 0 regressions)
- Production Incidents: 0
- Regressions: 0

### Stories Delivered

| Story | Title | Key Outcome |
|-------|-------|-------------|
| 3.1 | XP System & Orb Collection | xpOrbSystem.js (swap-to-end pool), usePlayer XP/level state, XPOrbRenderer (InstancedMesh), GameLoop integration. 18 tests |
| 3.2 | Level-Up System & Choice UI | progressionSystem.js, LevelUpModal.jsx, Interface.jsx (first UI overlay), useWeapons/useBoons extensions, 4 weapons + 4 boons defined. 30 tests |
| 3.3 | Weapon Slots & Upgrades | Full upgrade curves (levels 2-9) for 4 weapons, spread shot, homing missiles, per-instance projectile colors, visual upgrade thresholds. 21 tests |
| 3.4 | Boon System | Boon stacking tiers (levels 1-3), computeModifiers(), GameLoop modifier pipeline to weapons + player, boon_upgrade choices. 27 tests |
| 3.5 | HP System & Death | Audit + invulnerability timer, fixed hardcoded HP, fixed death-frame processing leak, useGame tests. 18 tests |

### Code Review Summary

| Story | HIGH | MEDIUM | LOW | Key Findings |
|-------|------|--------|-----|--------------|
| 3.1 | 1 | 3 | 2 | Multi-orb index corruption (swap-to-end iteration), pool overflow silent drop, player XP reset missing |
| 3.2 | 3 | 0 | 2 | progressionSystem needs weapon levels, tick reads upgrade overrides, fallback uses real weaponIds |
| 3.3 | 2 | 2 | 0 | upgradeVisuals persistence across non-threshold levels, overrides store fields |
| 3.4 | 1 | 2 | 0 | Missing description for new_boon choices, crit chance test coverage |
| 3.5 | 0 | 0 | 0 | Audit story — issues found during audit, not review |
| **Total** | **7** | **7** | **4** | 18 issues caught and fixed before merge |

## What Went Well

1. **Exceptional velocity** — 5 stories completed in a single day with 87 new tests and zero regressions. Proves that solid architecture foundations (Epics 1-2) compound into development speed.

2. **Architecture held perfectly** — The GameLoop → stores → renderers pattern absorbed all new features (XP orbs, level-up UI, weapon upgrades, boon modifiers, HP/death) without any architectural changes. The boon modifier pipeline (Story 3.4) passed modifiers as GameLoop parameters with zero inter-store imports — exactly as designed.

3. **Zero scope creep** — Unlike Epic 2 (which doubled from 4 to 9 stories), Epic 3 delivered exactly the 5 planned stories. No mid-epic additions needed.

4. **Zero out-of-scope modifications** — Complete discipline on "Files NOT to modify" lists in dev notes. Major improvement from Epic 2's EnemyRenderer rewrite incident.

5. **Test coverage growth** — From 156 to 243 tests, consistently growing with each story. Zero regressions across the entire epic.

6. **Code review effectiveness** — 18 real bugs caught across 5 reviews, including critical issues (index corruption, death-frame leak, phase transition bug). Reviews are a proven safety net.

7. **Mockups accelerated UI work** — Visual references from Vampire Survivors in story dev notes eliminated design ambiguity for Story 3.2's LevelUpModal.

8. **Breakthrough patterns established** — Interface.jsx overlay (foundation for all Epic 4 UI), per-instance projectile colors (single draw call), boon modifier pipeline, homing missile steering.

## Challenges

1. **Phase transition fragility** — Two critical bugs related to simultaneous events in the same frame:
   - Story 3.2: GameLoop reset block triggered on levelUp→gameplay transition (overwrote enemy state)
   - Story 3.5: Death + level-up in same frame — `triggerLevelUp()` overwrote `gameOver` phase
   - Root cause: procedural event processing without priority guarantees

2. **Persistent magic numbers** — Third consecutive epic with hardcoded constants found. Story 3.5 discovered `currentHP: 100` instead of `GAME_CONFIG.PLAYER_BASE_HP`. Verbal reminders and template rules insufficient.

3. **Incomplete data at system boundaries** — progressionSystem choice objects missing required fields in Stories 3.2 (H1, H3) and 3.4 (H1). Pattern: data producers don't validate completeness, consumers discover gaps.

4. **No integration tests** — All 243 tests are unit tests. Phase transition bugs and cross-system interaction bugs slip through because each system tests correctly in isolation.

## Previous Retro (Epic 2) Follow-Through

| # | Action Item | Status | Evidence |
|---|-------------|--------|----------|
| 1 | All constants in gameConfig — zero magic numbers | ⏳ Partial | Story 3.5 found hardcoded HP (100 instead of GAME_CONFIG.PLAYER_BASE_HP). Fixed in audit. |
| 2 | Strict DO NOT MODIFY / scope respect | ✅ Complete | Zero out-of-scope rewrites in all 5 stories. "Files NOT to modify" enforced. |
| 3 | Provide mockups for UI stories | ✅ Complete | Mockups provided for Stories 3.2, 3.3, 3.4, 3.5 in `mockups/` folder |
| 4 | Use placeholder visuals for boons/weapons | ✅ Complete | Stories 3.3 and 3.4 functional with color/letter placeholders |
| 5 | Reference mockup folder in story dev notes | ✅ Complete | Every UI story references mockups in Dev Notes section |
| 6 | Embed anti-magic-number and scope rules in template | ⏳ Partial | Rules present in dev notes but hardcoded HP still slipped through |

**Assessment:** 4/6 fully completed (up from 1/3 in Epic 2). Structural action items (scope lists, mockup folder, placeholder pattern) succeeded. Reminder-based action items (magic numbers) partially failed again.

**Key learning:** Action items succeed when embedded as structures (files, folders, template sections). They fail when they remain verbal reminders or suggestions.

## Key Insights

1. **Architecture investment compounds into velocity** — The config-driven, layered architecture made adding 5 complex features in one day possible. Each story followed established patterns rather than inventing new ones.

2. **Phase transitions are the new bug frontier** — Individual systems are well-tested and stable. The interactions between them during state transitions are where bugs hide. Need systematic safety patterns.

3. **Structural action items work, verbal reminders don't** — "Files NOT to modify" lists, mockup folders, placeholder patterns all succeeded. "Remember to use gameConfig" failed for the third time. Solution: make the right thing the easy thing through tooling/structure.

4. **Code review catches interaction bugs that unit tests miss** — 7 HIGH issues caught in review, several involving cross-system interactions (phase transitions, data flow between systems).

## Technical Debt

| Item | Severity | Impact on Epic 4 | Action |
|------|----------|-------------------|--------|
| `systemTimer` never incremented in GameLoop | MEDIUM | Story 4.1a needs working timer | Fix in Story 4.1a (absorbed, not separate work) |
| No `kills` counter in stores | MEDIUM | Story 4.3 needs kill stats for game over screen | Fix in Story 4.1a (absorbed) |
| Rapier installed but unused | LOW | ~200kb bundle impact, no runtime cost | Adam's call to keep or remove |
| No dispose() on GLB geometries at unmount | MEDIUM | Risk increases with Epic 4 scene transitions | Address in Epic 4 as scene mounts/unmounts become frequent |
| No integration tests for cross-system interactions | LOW | Phase transition bugs may recur | Consider adding 2-3 critical path integration tests |

## Action Items

### Process Improvements

| # | Action | Owner | Success Criteria |
|---|--------|-------|------------------|
| 1 | Phase transition safety — add early returns after all state-changing calls in GameLoop | Bob (SM) / Dev agent | 0 phase transition bugs in Epic 4 reviews |
| 2 | Cross-system data contracts — validate required fields at system boundaries | Dev agent | 0 "missing field" HIGHs in Epic 4 reviews |
| 3 | Magic numbers — automated audit step in code review checklist (grep for hardcoded numbers) | Bob (SM) | 0 hardcoded gameplay constants in Epic 4 |
| 4 | Mockups for all UI stories (4.1b through 4.6) | Adam | Mockup present in `mockups/` before dev starts |

### Team Agreements

- Stories remain focused — if a story covers more than 2 distinct domains, split it
- "Files NOT to modify" lists are a strict contract, not a suggestion
- Every code review explicitly checks: magic numbers, phase transition safety, data completeness at boundaries

### Epic Status Update

| Action | Details |
|--------|---------|
| Mark epic-3 as "done" | All 5 stories complete |
| Mark epic-3-retrospective as "done" | This retrospective |

## Epic 4 Readiness Assessment

### Dependencies on Epic 3 — All Met

- ✅ HP system (usePlayer.currentHP/maxHP) — for HUD and game over
- ✅ XP/level system (currentXP, currentLevel, xpToNextLevel) — for HUD and stats
- ✅ Weapon slots (useWeapons.activeWeapons) — for HUD weapon display
- ✅ Boon system (useBoons.activeBoons, modifiers) — for game over stats
- ✅ Death detection (HP → 0 → gameOver phase) — for game over transition
- ✅ Level-up UI (Interface.jsx overlay pattern) — foundation for all Epic 4 UI
- ✅ 243 tests passing, zero regressions
- ✅ Codebase assessed as solid and maintainable

### Preparation Needed

- **Split Story 4.1** into 4.1a (Phase Management + Timer + Kills + Restart) and 4.1b (Main Menu UI + 3D background) — Bob (SM) during create-story
- **Mockups for UI stories** — Adam to provide before dev starts on each story
- **No critical prep sprint required** — all dependencies met, 2 minor gaps (timer, kills) absorbed into Story 4.1a
- **No blocking technical debt**

### New Components for Epic 4

- `MainMenu.jsx` — first full-screen UI component with 3D background
- `HUD.jsx` — HP bar, timer, XP bar, minimap, weapon slots
- `GameOverScreen.jsx` — cinematic sequence with stats
- `VictoryScreen.jsx` — completion stats
- `audioManager.js` — Howler.js wrapper for music + SFX
- UI primitives: `Button.jsx`, `ProgressBar.jsx`, `StatLine.jsx`

### Risks for Epic 4

| Risk | Mitigation |
|------|------------|
| Heavy UI territory — 5+ new UI components, new domain | Mockups for every story, Interface.jsx pattern established |
| Audio system from scratch (Howler.js) | Architecture doc has audioManager spec, Howler.js is simple API |
| Scene transitions (menu→gameplay→gameOver) increase disposal risk | Monitor GLB geometry disposal, add cleanup if leaks detected |
| Game over cinematic sequence (complex animation chain) | Clear UX spec with timing values, Adam mockup |

### Deployment

- Deployment planned after Epic 4 completion (full game loop required for first public impression)
- Target: Vercel for Three.js Journey contest

### Verdict

**READY TO START EPIC 4** — No blockers, no prep sprint needed. Story 4.1 split recommended, mockups to be provided by Adam.

## Next Steps

1. Mark epic-3 and epic-3-retrospective as "done" in sprint-status.yaml
2. Adam provides mockups for Epic 4 UI stories
3. Bob (SM) splits Story 4.1 into 4.1a and 4.1b during create-story
4. Bob (SM) embeds phase transition safety and magic number audit rules in story templates
5. Start creating Epic 4 stories with `create-story`
