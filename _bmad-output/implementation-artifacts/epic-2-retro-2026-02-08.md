# Retrospective — Epic 2: Combat & Enemy Waves

**Date:** 2026-02-08
**Facilitator:** Bob (Scrum Master)
**Epic Status:** Complete (9/9 stories done)
**Participants:** Adam (Project Lead), Alice (Product Owner), Bob (Scrum Master), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev)

## Epic 2 Summary

### Delivery Metrics

- Stories Completed: 9/9 (100%)
- Stories Originally Planned: 4 (2.1–2.4)
- Stories Added Mid-Epic: 5 (2.5–2.9) — tuning & polish
- Code Reviews Completed: 9/9
- Test Coverage: 0 → 137 tests across 11 test files
- Production Incidents: 0
- Regressions: 0

### Stories Delivered

| Story | Title | Key Outcome |
|-------|-------|-------------|
| 2.1 | Spatial Hashing & Collision System | spatialHash.js + collisionSystem.js, circle-vs-circle detection, GameLoop integration, Vitest setup, 30 tests |
| 2.2 | Enemy Spawning & Rendering | spawnSystem.js, useEnemies store, EnemyRenderer (InstancedMesh per type), zero-GC tick pattern, 56 tests |
| 2.3 | Auto-Fire & Projectile System | projectileSystem.js, useWeapons store, ProjectileRenderer. Major review fix: reverted out-of-scope EnemyRenderer rewrite |
| 2.4 | Combat Resolution & Feedback | takeDamage, damageEnemiesBatch, ParticleRenderer with swap-and-pop pool. Review fix: particleSystem extracted to systems/ layer |
| 2.5 | Enemy GLB Models & Rendering | Multi-mesh GLB extraction via useGLTF, baked matrixWorld into cloned geometries for InstancedMesh. ErrorBoundary added |
| 2.6 | Enemy Speed & Facing Tuning | Speeds reduced ~3x (FODDER_BASIC 50→17, FODDER_FAST 90→30), facing rotation formula simplified |
| 2.7 | Hitbox Tuning & Hit Feedback | Collision radii proportional to meshScale (0.5→1.5, 0.4→1.2), scale pulse hit feedback via lastHitTime |
| 2.8 | Player Rotation Responsiveness | PLAYER_ROTATION_SPEED 10→20, frame-rate-independent exponential decay lerp |
| 2.9 | Projectile Size & Spawn Offset | Projectile 5x larger, radius 0.3→1.5, spawn Y=-0.5 and forward=2.5 along facing direction |

## What Went Well

1. **Flexible architecture absorbed scope changes** — 5 tuning stories (2.5–2.9) added mid-epic and integrated without friction. Centralized configs (gameConfig, weaponDefs, enemyDefs) made gameplay tuning trivial — often just changing values
2. **Solid foundations never retouched** — Spatial hash (2.1) and InstancedMesh zero-GC pattern (2.2) were built once and worked throughout the entire epic
3. **Test coverage grew consistently** — From 0 to 137 tests across 11 files. Each story added tests, zero regressions across the full epic
4. **Code review process caught real issues** — Architecture violations (2.4), frame-rate-dependent bugs (2.8), magic numbers (2.7, 2.8, 2.9), out-of-scope rewrites (2.3). Reviews are an effective safety net
5. **Memory management mastered** — useRef for dummy Object3D, zero-GC tick patterns, no memory leaks detected. Epic 1 action item fully applied
6. **Breakthrough technical patterns** — swap-and-pop particle pool (2.4), multi-mesh GLB extraction with baked matrixWorld (2.5), exponential decay `1 - Math.exp(-speed * delta)` rotation (2.8)

## Challenges

1. **DO NOT MODIFY violations** — Story 2.3 dev agent rewrote EnemyRenderer completely out of scope, replacing InstancedMesh with per-enemy GLB clones (performance bomb). Required full revert. Major token waste
2. **Recurring magic numbers** — Stories 2.7, 2.8, 2.9 all had hardcoded constants flagged in code review and extracted to gameConfig. Same issue three stories in a row — discipline not internalized
3. **Architecture layer violations** — Story 2.4 placed particleSystem in stores/ instead of systems/. Caught in review but should have been correct from the start
4. **Scope doubled** — From 4 planned stories to 9. Driven primarily by GLB model complexity (2.5) which cascaded into tuning stories (2.6–2.9). Not necessarily a problem, but worth noting
5. **GLB model complexity surprised the team** — Multi-mesh SkinnedMesh with 100x parent scale in Story 2.5. Epic 1 action item on GLB orientation was only partially applied
6. **Frame-rate-dependent code** — Rotation lerp in Story 2.8 used naive `diff * speed * delta` which overshoots below 20fps. Caught in review, fixed with exponential decay
7. **Mixed uncommitted changes** — Stories 2.5 and 2.6 had interleaved uncommitted changes, complicating review

## Previous Retro (Epic 1) Follow-Through

| # | Action Item | Status | Evidence |
|---|-------------|--------|----------|
| 1 | Document GLB orientation convention (-Z forward) | ⏳ Partial | Story 2.5 still hit multi-mesh/scale surprises. Convention exists but wasn't sufficient for complex GLB models |
| 2 | All tunable values in gameConfig from the start | ⏳ Partial | Magic numbers flagged in 3 consecutive stories (2.7, 2.8, 2.9). Fixed in review each time, but not applied proactively |
| 3 | Memory management checklist (dispose, cleanup, unload) | ✅ Complete | useRef for dummy Object3D, zero-GC patterns throughout, no memory leaks detected |

**Assessment:** 1/3 fully completed, 2/3 partially applied. The fully completed item (memory management) had clear, measurable impact — zero leaks. The partially applied items continued to cause review cycles and token waste.

## Key Insights

1. **First-jet quality has direct token cost** — Every code review round-trip for the same recurring issues (magic numbers, scope violations) is wasted budget. Getting it right the first time is not just about code quality, it's about efficiency
2. **Action items only work when systematically enforced** — Memory management succeeded because it became a reflex. Magic numbers failed because it stayed a suggestion. Solution: embed rules directly in story templates
3. **Architecture flexibility enables rapid iteration** — The config-driven design made tuning stories trivial, proving the architecture's value for gameplay iteration
4. **Code review is the safety net, not the goal** — Reviews should catch novel issues, not the same pattern three times in a row

## Technical Debt

| Item | Severity | Impact on Epic 3 | Action |
|------|----------|-------------------|--------|
| Rapier installed but unused | LOW | No impact | Carry forward from Epic 1 — Adam's call to keep or remove |
| No integration tests for full combat loop | LOW | Would catch cross-system bugs | Consider adding in Epic 3 as systems grow more interconnected |
| Placeholder enemy models (will need final art) | LOW | No impact on Epic 3 gameplay | Art pass deferred to polish phase |
| No dispose() calls on GLB geometries at unmount | MEDIUM | Could leak if scene remounts frequently | Monitor in Epic 3, add cleanup if needed |

## Action Items

### Process Improvements

| # | Action | Owner | Success Criteria |
|---|--------|-------|------------------|
| 1 | All constants in gameConfig/weaponDefs/enemyDefs from first jet — zero magic numbers | Dev agent | 0 "hardcoded constant" findings in Epic 3 reviews |
| 2 | Strict DO NOT MODIFY / scope respect — only modify files listed in story | Dev agent | 0 out-of-scope rewrites in Epic 3 |
| 3 | Provide mockups for UI stories in `_bmad-output/planning-artifacts/mockups/` | Adam | Mockup present for each UI story before dev starts |
| 4 | Use placeholder letters/colors for boons and weapons — no asset blocking | Dev agent | Stories 3.3 and 3.4 functional with zero image assets |
| 5 | Reference mockup folder in story dev notes for UI stories | Bob (SM) | Each UI story points to its mockup in dev notes |
| 6 | Embed anti-magic-number and scope rules in story template | Bob (SM) | Rules present in every Epic 3 story's dev notes |

### Epic Status Update

| Action | Details |
|--------|---------|
| Mark epic-2-retrospective as "done" | This retrospective |

## Epic 3 Readiness Assessment

### Dependencies on Epic 2 — All Met

- ✅ Combat system functional (auto-fire, projectiles, collisions, damage)
- ✅ Enemy spawning and rendering (InstancedMesh pattern, spawnSystem)
- ✅ Spatial hashing for collision detection
- ✅ Particle system for visual feedback
- ✅ GameLoop with deterministic tick order
- ✅ 137 tests passing, zero regressions

### Preparation Needed

- **Mockup folder**: Create `_bmad-output/planning-artifacts/mockups/` (Adam to populate)
- **Story template update**: Embed process rules from action items 1, 2, 6
- **No critical prep sprint required** — Epic 2 foundation covers all Epic 3 dependencies
- **No blocking technical debt**

### New Components for Epic 3

- `useBoons` store — boon state management
- `useLevel` store — XP and level progression (may extend existing)
- `progressionSystem.js` — XP/level-up logic
- `XPOrbRenderer.jsx` — XP orb rendering
- Level-up choice UI — first interactive UI component (Story 3.2)

### Risks for Epic 3

| Risk | Mitigation |
|------|------------|
| First interactive UI (level-up choice) — new territory | Adam provides mockup, reduces ambiguity |
| Boon combinatorics — testing all interactions | Start with placeholder visuals, focus on logic testing |
| HP/death system changes game fundamentally (3.5) | Clear story scope, thorough testing |
| Interconnected progression systems | Leverage existing store-based tick pattern, keep systems decoupled |

### Verdict

**READY TO START EPIC 3** — No blockers, no prep sprint needed. Mockup folder to be created, story template to be updated with process rules.

## Next Steps

1. Mark epic-2-retrospective as "done" in sprint-status.yaml
2. Create `_bmad-output/planning-artifacts/mockups/` folder
3. Update story template with anti-magic-number and scope rules
4. Adam provides mockups for UI stories (3.2 level-up HUD)
5. Start creating Epic 3 stories with `create-story`
6. Epic 3 will auto-transition to "in-progress" when first story is created
